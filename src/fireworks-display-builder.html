<!DOCTYPE html>
<html lang="en">
<!--
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                       FIREWORKS DISPLAY BUILDER                              ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  A real-time interactive fireworks choreography and sequencing tool         ‚ïë
‚ïë  Built with Three.js for 3D particle simulation and 8-bit audio             ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  Features:                                                                   ‚ïë
‚ïë  ‚Ä¢ 12 firework types (Classic, Peony, Willow, Chrysanthemum, etc.)         ‚ïë
‚ïë  ‚Ä¢ 10 color palette options                                                 ‚ïë
‚ïë  ‚Ä¢ Timeline-based show sequencing with track editor                         ‚ïë
‚ïë  ‚Ä¢ Real-time 3D preview with 100k particle system                          ‚ïë
‚ïë  ‚Ä¢ 8-bit style procedural audio synthesis                                   ‚ïë
‚ïë  ‚Ä¢ Save/Load shows as JSON                                                  ‚ïë
‚ïë  ‚Ä¢ 4 preset choreographed shows                                             ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  Usage:                                                                      ‚ïë
‚ïë  ‚Ä¢ Select a firework type and color                                         ‚ïë
‚ïë  ‚Ä¢ Click on canvas to launch fireworks manually                             ‚ïë
‚ïë  ‚Ä¢ Use timeline to add launches at specific times                           ‚ïë
‚ïë  ‚Ä¢ Press Play to run your choreographed show                                ‚ïë
‚ïë  ‚Ä¢ Load preset shows for inspiration                                        ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  Technology Stack:                                                           ‚ïë
‚ïë  ‚Ä¢ Three.js r128 - 3D rendering and particle system                         ‚ïë
‚ïë  ‚Ä¢ Web Audio API - Procedural sound synthesis                               ‚ïë
‚ïë  ‚Ä¢ Vanilla JavaScript - No build tools required                             ‚ïë
‚ïë                                                                              ‚ïë
‚ïë  License: MIT                                                                ‚ïë
‚ïë  Author: NIMO Labs LLC                                                       ‚ïë
‚ïë  Repository: [Add your repo URL here]                                       ‚ïë
‚ïë                                                                              ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Interactive fireworks display builder with real-time 3D preview and timeline sequencing">
    <meta name="keywords" content="fireworks, three.js, particle system, animation, sequencer">
    <title>Fireworks Display Builder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #0a0a12;
            color: #e0e0e0;
            overflow: hidden;
            user-select: none;
        }
        
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - 200px);
        }
        
        #ui-overlay {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .panel {
            background: rgba(20, 20, 35, 0.9);
            border: 1px solid rgba(100, 100, 150, 0.3);
            border-radius: 8px;
            padding: 12px;
            backdrop-filter: blur(10px);
        }
        
        .panel h3 {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #8888aa;
            margin-bottom: 10px;
        }
        
        .firework-palette {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }
        
        .firework-btn {
            padding: 8px 6px;
            font-size: 11px;
            background: rgba(60, 60, 100, 0.5);
            border: 1px solid rgba(100, 100, 180, 0.3);
            border-radius: 4px;
            color: #c0c0e0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .firework-btn:hover {
            background: rgba(80, 80, 140, 0.7);
            border-color: rgba(150, 150, 255, 0.5);
        }
        
        .firework-btn.selected {
            background: rgba(100, 80, 200, 0.7);
            border-color: rgba(180, 150, 255, 0.8);
            box-shadow: 0 0 10px rgba(150, 100, 255, 0.3);
        }
        
        .color-picker {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        
        .color-swatch {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .color-swatch:hover {
            transform: scale(1.1);
        }
        
        .color-swatch.selected {
            border-color: white;
            box-shadow: 0 0 8px currentColor;
        }
        
        .controls {
            display: flex;
            gap: 8px;
        }
        
        .ctrl-btn {
            padding: 8px 16px;
            font-size: 12px;
            background: rgba(60, 60, 100, 0.5);
            border: 1px solid rgba(100, 100, 180, 0.3);
            border-radius: 4px;
            color: #c0c0e0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .ctrl-btn:hover {
            background: rgba(80, 80, 140, 0.7);
        }
        
        .ctrl-btn.active {
            background: rgba(50, 180, 100, 0.6);
            border-color: rgba(100, 255, 150, 0.5);
        }
        
        #presets-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 100;
        }
        
        .preset-btn {
            display: block;
            width: 100%;
            margin-bottom: 6px;
            padding: 8px 12px;
            font-size: 11px;
            background: rgba(60, 60, 100, 0.5);
            border: 1px solid rgba(100, 100, 180, 0.3);
            border-radius: 4px;
            color: #c0c0e0;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }
        
        .preset-btn:hover {
            background: rgba(80, 80, 140, 0.7);
        }
        
        #timeline-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 200px;
            background: rgba(15, 15, 25, 0.95);
            border-top: 1px solid rgba(100, 100, 150, 0.3);
            display: flex;
            flex-direction: column;
        }
        
        #timeline-controls {
            display: flex;
            align-items: center;
            padding: 8px 15px;
            gap: 15px;
            border-bottom: 1px solid rgba(100, 100, 150, 0.2);
        }
        
        #time-display {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #80ff80;
            min-width: 80px;
        }
        
        #timeline-scroll {
            flex: 1;
            overflow-x: auto;
            overflow-y: hidden;
            position: relative;
        }
        
        #timeline {
            position: relative;
            height: 100%;
            min-width: 100%;
        }
        
        #timeline-ruler {
            height: 25px;
            background: rgba(30, 30, 50, 0.8);
            position: relative;
            border-bottom: 1px solid rgba(100, 100, 150, 0.2);
        }
        
        .ruler-mark {
            position: absolute;
            top: 0;
            height: 100%;
            border-left: 1px solid rgba(100, 100, 150, 0.3);
            font-size: 10px;
            color: #666;
            padding-left: 4px;
            padding-top: 2px;
        }
        
        .ruler-mark.major {
            border-left-color: rgba(150, 150, 200, 0.5);
            color: #999;
        }
        
        #timeline-tracks {
            flex: 1;
            position: relative;
            overflow-y: auto;
        }
        
        .track {
            height: 40px;
            border-bottom: 1px solid rgba(100, 100, 150, 0.1);
            position: relative;
        }
        
        .track-label {
            position: absolute;
            left: 0;
            top: 0;
            width: 80px;
            height: 100%;
            background: rgba(25, 25, 40, 0.9);
            display: flex;
            align-items: center;
            padding-left: 10px;
            font-size: 11px;
            color: #888;
            border-right: 1px solid rgba(100, 100, 150, 0.2);
            z-index: 5;
        }
        
        .track-content {
            position: absolute;
            left: 80px;
            right: 0;
            top: 0;
            height: 100%;
        }
        
        .timeline-event {
            position: absolute;
            height: 32px;
            top: 4px;
            border-radius: 4px;
            cursor: move;
            display: flex;
            align-items: center;
            padding: 0 8px;
            font-size: 10px;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            min-width: 60px;
            transition: box-shadow 0.2s;
        }
        
        .timeline-event:hover {
            box-shadow: 0 0 10px rgba(255,255,255,0.3);
        }
        
        .timeline-event.selected {
            box-shadow: 0 0 0 2px white, 0 0 15px rgba(255,255,255,0.5);
        }
        
        .timeline-event .delete-btn {
            position: absolute;
            right: 2px;
            top: 2px;
            width: 14px;
            height: 14px;
            background: rgba(255,50,50,0.8);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 10px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        .timeline-event:hover .delete-btn {
            display: flex;
        }
        
        #playhead {
            position: absolute;
            top: 0;
            width: 2px;
            height: 100%;
            background: #ff4444;
            z-index: 10;
            pointer-events: none;
        }
        
        #playhead::before {
            content: '';
            position: absolute;
            top: 0;
            left: -6px;
            width: 14px;
            height: 14px;
            background: #ff4444;
            clip-path: polygon(50% 100%, 0 0, 100% 0);
        }
        
        #drop-zone {
            position: absolute;
            left: 80px;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 1;
        }
        
        .zoom-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        
        .zoom-btn {
            width: 28px;
            height: 28px;
            font-size: 16px;
            background: rgba(60, 60, 100, 0.5);
            border: 1px solid rgba(100, 100, 180, 0.3);
            border-radius: 4px;
            color: #c0c0e0;
            cursor: pointer;
        }
        
        .zoom-btn:hover {
            background: rgba(80, 80, 140, 0.7);
        }
        
        #duration-input {
            width: 60px;
            padding: 4px 8px;
            background: rgba(40, 40, 70, 0.8);
            border: 1px solid rgba(100, 100, 180, 0.3);
            border-radius: 4px;
            color: #c0c0e0;
            font-size: 12px;
        }
        
        .file-controls {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }
        
        #click-to-launch-hint {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(255,255,255,0.3);
            font-size: 14px;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .hidden {
            display: none !important;
        }
        
        #debug-overlay {
            position: fixed;
            bottom: 210px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: #0f0;
            font-family: monospace;
            font-size: 11px;
            padding: 8px;
            border-radius: 4px;
            z-index: 1000;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    
    <div id="debug-overlay">Loading...</div>
    
    <div id="click-to-launch-hint">Click anywhere to launch selected firework</div>
    
    <div id="ui-overlay">
        <div class="panel">
            <h3>Firework Type</h3>
            <div class="firework-palette">
                <button class="firework-btn selected" data-type="classic">Classic</button>
                <button class="firework-btn" data-type="peony">Peony</button>
                <button class="firework-btn" data-type="willow">Willow</button>
                <button class="firework-btn" data-type="chrysanthemum">Chrysanth</button>
                <button class="firework-btn" data-type="palm">Palm</button>
                <button class="firework-btn" data-type="crossette">Crossette</button>
                <button class="firework-btn" data-type="ring">Ring</button>
                <button class="firework-btn" data-type="heart">Heart</button>
                <button class="firework-btn" data-type="star">Star</button>
                <button class="firework-btn" data-type="multibreak">Multi-Break</button>
                <button class="firework-btn" data-type="spiral">Spiral</button>
                <button class="firework-btn" data-type="gandalf">‚ú® Gandalf</button>
            </div>
            <div class="color-picker">
                <div class="color-swatch selected" data-color="#ff3333" style="background:#ff3333"></div>
                <div class="color-swatch" data-color="#ff8833" style="background:#ff8833"></div>
                <div class="color-swatch" data-color="#ffff33" style="background:#ffff33"></div>
                <div class="color-swatch" data-color="#33ff33" style="background:#33ff33"></div>
                <div class="color-swatch" data-color="#33ffff" style="background:#33ffff"></div>
                <div class="color-swatch" data-color="#3333ff" style="background:#3333ff"></div>
                <div class="color-swatch" data-color="#ff33ff" style="background:#ff33ff"></div>
                <div class="color-swatch" data-color="#ffffff" style="background:#ffffff"></div>
                <div class="color-swatch" data-color="#ffcc00" style="background:#ffcc00"></div>
                <div class="color-swatch" data-color="#ff6699" style="background:#ff6699"></div>
            </div>
        </div>
        
        <div class="panel">
            <h3>Playback</h3>
            <div class="controls">
                <button class="ctrl-btn" id="play-btn">‚ñ∂ Play</button>
                <button class="ctrl-btn" id="stop-btn">‚¨õ Stop</button>
                <button class="ctrl-btn" id="loop-btn">üîÅ Loop</button>
            </div>
        </div>
    </div>
    
    <div id="presets-panel" class="panel">
        <h3>Preset Shows</h3>
        <button class="preset-btn" data-preset="opener">üéÜ Opening Burst</button>
        <button class="preset-btn" data-preset="crescendo">üìà Crescendo</button>
        <button class="preset-btn" data-preset="finale">üéá Grand Finale</button>
        <button class="preset-btn" data-preset="gandalf-show">üßô Gandalf's Display</button>
    </div>
    
    <div id="timeline-container">
        <div id="timeline-controls">
            <button class="ctrl-btn" id="tl-play-btn">‚ñ∂</button>
            <span id="time-display">0:00.0</span>
            <div class="zoom-controls">
                <button class="zoom-btn" id="zoom-out">‚àí</button>
                <button class="zoom-btn" id="zoom-in">+</button>
            </div>
            <label style="font-size:12px;color:#888;">
                Duration: <input type="number" id="duration-input" value="30" min="5" max="300">s
            </label>
            <div class="file-controls">
                <button class="ctrl-btn" id="save-btn">üíæ Save</button>
                <button class="ctrl-btn" id="load-btn">üìÇ Load</button>
                <button class="ctrl-btn" id="clear-btn">üóëÔ∏è Clear</button>
                <input type="file" id="file-input" accept=".json" style="display:none">
            </div>
        </div>
        <div id="timeline-scroll">
            <div id="timeline">
                <div id="timeline-ruler"></div>
                <div id="timeline-tracks">
                    <div class="track" data-track="0">
                        <div class="track-label">Track 1</div>
                        <div class="track-content"></div>
                    </div>
                    <div class="track" data-track="1">
                        <div class="track-label">Track 2</div>
                        <div class="track-content"></div>
                    </div>
                    <div class="track" data-track="2">
                        <div class="track-label">Track 3</div>
                        <div class="track-content"></div>
                    </div>
                    <div class="track" data-track="3">
                        <div class="track-label">Track 4</div>
                        <div class="track-content"></div>
                    </div>
                </div>
                <div id="playhead" style="left:80px;"></div>
                <div id="drop-zone"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        /*
         * CODE STRUCTURE OVERVIEW
         * ========================
         * 1. Audio System - 8-bit style procedural sound synthesis
         * 2. Three.js Setup - Scene, camera, renderer, skybox
         * 3. Particle Pool - Pre-allocated particle system (100k particles)
         * 4. Particle Geometry - Three.js BufferGeometry for rendering
         * 5. Firework Types - 12 different explosion patterns with physics
         * 6. Timeline System - Track-based sequencing with playback
         * 7. Preset Shows - Pre-choreographed demonstration sequences
         * 8. UI Controls - Event handlers for user interaction
         * 9. Animation Loop - Main render and physics update loop
         */
        
        // ==================== AUDIO SYSTEM ====================
        class Audio8Bit {
            constructor() {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            resume() {
                if (this.ctx.state === 'suspended') this.ctx.resume();
            }
            
            playLaunch() {
                this.resume();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(800, this.ctx.currentTime + 0.15);
                
                gain.gain.setValueAtTime(0.15, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.3);
                
                osc.start(this.ctx.currentTime);
                osc.stop(this.ctx.currentTime + 0.3);
            }
            
            playExplosion(intensity = 1) {
                this.resume();
                const bufferSize = this.ctx.sampleRate * 0.4;
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                
                for (let i = 0; i < bufferSize; i++) {
                    const t = i / bufferSize;
                    // 8-bit style noise with decay
                    const noise = Math.random() * 2 - 1;
                    const quantized = Math.round(noise * 8) / 8;
                    data[i] = quantized * Math.pow(1 - t, 2) * intensity;
                }
                
                const source = this.ctx.createBufferSource();
                const gain = this.ctx.createGain();
                source.buffer = buffer;
                source.connect(gain);
                gain.connect(this.ctx.destination);
                gain.gain.value = 0.25;
                source.start();
            }
            
            playCrackle() {
                this.resume();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                
                osc.type = 'square';
                const now = this.ctx.currentTime;
                
                for (let i = 0; i < 5; i++) {
                    const t = now + i * 0.05;
                    osc.frequency.setValueAtTime(800 + Math.random() * 400, t);
                }
                
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.25);
                
                osc.start(now);
                osc.stop(now + 0.25);
            }
            
            playMagic() {
                this.resume();
                const osc = this.ctx.createOscillator();
                const osc2 = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                
                osc.connect(gain);
                osc2.connect(gain);
                gain.connect(this.ctx.destination);
                
                osc.type = 'sine';
                osc2.type = 'triangle';
                
                const now = this.ctx.currentTime;
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(1200, now + 0.5);
                osc2.frequency.setValueAtTime(603, now);
                osc2.frequency.exponentialRampToValueAtTime(1206, now + 0.5);
                
                gain.gain.setValueAtTime(0.15, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.6);
                
                osc.start(now);
                osc2.start(now);
                osc.stop(now + 0.6);
                osc2.stop(now + 0.6);
            }
        }
        
        const audio = new Audio8Bit();

        // ==================== THREE.JS SETUP ====================
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.set(0, 5, 30);
        camera.lookAt(0, 10, 0);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        container.appendChild(renderer.domElement);
        
        // Resume AudioContext on first user interaction (browser requirement)
        let audioResumed = false;
        const resumeAudio = () => {
            if (!audioResumed) {
                audio.resume();
                audioResumed = true;
                document.removeEventListener('click', resumeAudio);
                document.removeEventListener('touchstart', resumeAudio);
            }
        };
        document.addEventListener('click', resumeAudio);
        document.addEventListener('touchstart', resumeAudio);
        
        // Gradient sky
        const skyGeo = new THREE.PlaneGeometry(200, 100);
        const skyMat = new THREE.ShaderMaterial({
            uniforms: {
                topColor: { value: new THREE.Color(0x0a0a20) },
                bottomColor: { value: new THREE.Color(0x1a1a3a) }
            },
            vertexShader: `
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `,
            fragmentShader: `
                uniform vec3 topColor;
                uniform vec3 bottomColor;
                varying vec2 vUv;
                void main() {
                    gl_FragColor = vec4(mix(bottomColor, topColor, vUv.y), 1.0);
                }
            `,
            side: THREE.DoubleSide,
            depthWrite: false
        });
        const sky = new THREE.Mesh(skyGeo, skyMat);
        sky.position.z = -50;
        sky.position.y = 25;
        scene.add(sky);
        
        // ==================== PARTICLE POOL (must be before any code that uses particles) ====================
        const MAX_PARTICLES = 100000;
        
        class Particle {
            constructor() {
                this.active = false;
                this.x = 0; this.y = 0; this.z = 0;
                this.vx = 0; this.vy = 0; this.vz = 0;
                this.r = 1; this.g = 1; this.b = 1;
                this.size = 1;
                this.alpha = 1;
                this.life = 0;
                this.maxLife = 1;
                this.gravity = 0.015;
                this.drag = 0.98;
                this.fadeStart = 0.3;
                this.trail = false;
                this.trailDecay = 0.95;
            }
            
            update(dt) {
                if (!this.active) return;
                
                this.life -= dt;
                if (this.life <= 0) {
                    this.active = false;
                    return;
                }
                
                this.vy -= this.gravity;
                this.vx *= this.drag;
                this.vy *= this.drag;
                this.vz *= this.drag;
                
                this.x += this.vx;
                this.y += this.vy;
                this.z += this.vz;
                
                const lifeRatio = this.life / this.maxLife;
                if (lifeRatio < this.fadeStart) {
                    this.alpha = lifeRatio / this.fadeStart;
                }
                
                if (this.trail) {
                    this.size *= this.trailDecay;
                }
            }
        }
        
        const particles = [];
        for (let i = 0; i < MAX_PARTICLES; i++) {
            particles.push(new Particle());
        }
        
        function getParticle() {
            for (const p of particles) {
                if (!p.active) return p;
            }
            return null;
        }
        
        // ==================== PARTICLE SYSTEM GEOMETRY ====================
        const particleGeometry = new THREE.BufferGeometry();
        const positions = new Float32Array(MAX_PARTICLES * 3);
        const colors = new Float32Array(MAX_PARTICLES * 3);
        const sizes = new Float32Array(MAX_PARTICLES);
        const alphas = new Float32Array(MAX_PARTICLES);
        
        particleGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        particleGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
        particleGeometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
        particleGeometry.setAttribute('alpha', new THREE.BufferAttribute(alphas, 1));
        
        // Mark as dynamic for frequent updates
        particleGeometry.getAttribute('position').setUsage(THREE.DynamicDrawUsage);
        particleGeometry.getAttribute('color').setUsage(THREE.DynamicDrawUsage);
        particleGeometry.getAttribute('size').setUsage(THREE.DynamicDrawUsage);
        particleGeometry.getAttribute('alpha').setUsage(THREE.DynamicDrawUsage);
        
        // Initialize all positions to offscreen
        for (let i = 0; i < MAX_PARTICLES; i++) {
            positions[i * 3] = 0;
            positions[i * 3 + 1] = -1000;
            positions[i * 3 + 2] = 0;
            colors[i * 3] = 1;
            colors[i * 3 + 1] = 1;
            colors[i * 3 + 2] = 1;
            sizes[i] = 0;
            alphas[i] = 0;
        }
        
        // Start with 0 particles drawn
        particleGeometry.setDrawRange(0, 0);
        
        // Ground reference line
        const groundGeo = new THREE.PlaneGeometry(100, 0.1);
        const groundMat = new THREE.MeshBasicMaterial({ color: 0x222244 });
        const ground = new THREE.Mesh(groundGeo, groundMat);
        ground.rotation.x = -Math.PI / 2;
        ground.position.y = 0;
        scene.add(ground);
        
        const particleMaterial = new THREE.PointsMaterial({
            size: 0.5,
            vertexColors: true,
            transparent: true,
            blending: THREE.AdditiveBlending,
            depthWrite: false,
            sizeAttenuation: true
        });
        
        const particleSystem = new THREE.Points(particleGeometry, particleMaterial);
        particleSystem.frustumCulled = false; // Disable culling - particles move around
        scene.add(particleSystem);
        console.log('‚úÖ Particle system added, frustumCulled:', particleSystem.frustumCulled);
        console.log('üé® Material type:', particleMaterial.type);
        console.log('üé® Material vertexColors:', particleMaterial.vertexColors);
        console.log('üé® Material size:', particleMaterial.size);
        console.log('üé® Material transparent:', particleMaterial.transparent);

        // ==================== FIREWORK TYPES ====================
        const FIREWORK_TYPES = {
            classic: {
                name: 'Classic',
                particles: 300,
                speed: 0.3,
                life: 1.5,
                gravity: 0.012,
                drag: 0.97,
                size: 3,
                spread: 1
            },
            peony: {
                name: 'Peony',
                particles: 500,
                speed: 0.25,
                life: 2,
                gravity: 0.008,
                drag: 0.985,
                size: 4,
                spread: 1,
                trail: true
            },
            willow: {
                name: 'Willow',
                particles: 400,
                speed: 0.2,
                life: 3,
                gravity: 0.02,
                drag: 0.99,
                size: 3,
                spread: 0.8,
                trail: true,
                color: '#ffcc00'
            },
            chrysanthemum: {
                name: 'Chrysanthemum',
                particles: 600,
                speed: 0.35,
                life: 2.5,
                gravity: 0.01,
                drag: 0.98,
                size: 2.5,
                spread: 1,
                trail: true
            },
            palm: {
                name: 'Palm',
                particles: 200,
                speed: 0.4,
                life: 2,
                gravity: 0.015,
                drag: 0.96,
                size: 4,
                spread: 0.3,
                upwardBias: 0.7
            },
            crossette: {
                name: 'Crossette',
                particles: 150,
                speed: 0.35,
                life: 1.2,
                gravity: 0.012,
                drag: 0.97,
                size: 3,
                spread: 1,
                secondary: true,
                secondaryDelay: 0.6
            },
            ring: {
                name: 'Ring',
                particles: 200,
                speed: 0.3,
                life: 1.5,
                gravity: 0.01,
                drag: 0.97,
                size: 3,
                pattern: 'ring'
            },
            heart: {
                name: 'Heart',
                particles: 300,
                speed: 0.25,
                life: 2,
                gravity: 0.008,
                drag: 0.985,
                size: 3,
                pattern: 'heart'
            },
            star: {
                name: 'Star',
                particles: 250,
                speed: 0.3,
                life: 1.8,
                gravity: 0.01,
                drag: 0.97,
                size: 3,
                pattern: 'star'
            },
            multibreak: {
                name: 'Multi-Break',
                particles: 200,
                speed: 0.3,
                life: 1.5,
                gravity: 0.012,
                drag: 0.97,
                size: 3,
                stages: 3,
                stageDelay: 0.4
            },
            spiral: {
                name: 'Spiral',
                particles: 400,
                speed: 0.25,
                life: 2.5,
                gravity: 0.005,
                drag: 0.99,
                size: 2.5,
                pattern: 'spiral'
            },
            gandalf: {
                name: 'Gandalf',
                particles: 1000,
                speed: 0.35,
                life: 4,
                gravity: 0.005,
                drag: 0.995,
                size: 4,
                pattern: 'dragon',
                magical: true,
                stages: 5,
                stageDelay: 0.3
            }
        };
        
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16) / 255,
                g: parseInt(result[2], 16) / 255,
                b: parseInt(result[3], 16) / 255
            } : { r: 1, g: 1, b: 1 };
        }
        
        function createExplosion(x, y, z, type, color, scale = 1) {
            console.log('üéÜ createExplosion called:', { x, y, z, type, color, scale });
            const config = FIREWORK_TYPES[type] || FIREWORK_TYPES.classic;
            const rgb = hexToRgb(config.color || color);
            console.log('üé® Color RGB:', rgb);
            
            if (config.magical) {
                audio.playMagic();
            } else {
                audio.playExplosion(scale);
            }
            
            const numParticles = Math.floor(config.particles * scale);
            console.log('‚ú® Creating', numParticles, 'particles');
            
            let createdCount = 0;
            
            for (let i = 0; i < numParticles; i++) {
                const p = getParticle();
                if (!p) {
                    if (i === 0) console.warn('‚ùå No particles available!');
                    break;
                }
                createdCount++;
                
                let vx, vy, vz;
                const speed = config.speed * (0.5 + Math.random() * 0.5) * scale;
                
                if (config.pattern === 'ring') {
                    const angle = (i / numParticles) * Math.PI * 2;
                    vx = Math.cos(angle) * speed;
                    vy = Math.sin(angle) * speed * 0.3;
                    vz = Math.sin(angle) * speed * 0.5;
                } else if (config.pattern === 'heart') {
                    const t = (i / numParticles) * Math.PI * 2;
                    const hx = 16 * Math.pow(Math.sin(t), 3);
                    const hy = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
                    vx = hx * speed * 0.02;
                    vy = hy * speed * 0.02;
                    vz = (Math.random() - 0.5) * speed * 0.2;
                } else if (config.pattern === 'star') {
                    const angle = (i / numParticles) * Math.PI * 2;
                    const points = 5;
                    const r = (i % 2 === 0) ? 1 : 0.4;
                    vx = Math.cos(angle * points / 2) * speed * r;
                    vy = Math.sin(angle * points / 2) * speed * r;
                    vz = (Math.random() - 0.5) * speed * 0.3;
                } else if (config.pattern === 'spiral') {
                    const t = i / numParticles;
                    const angle = t * Math.PI * 8;
                    const r = t * speed;
                    vx = Math.cos(angle) * r;
                    vy = (1 - t) * speed + Math.sin(angle) * r * 0.3;
                    vz = Math.sin(angle) * r;
                } else if (config.pattern === 'dragon') {
                    // Dragon-like serpentine pattern
                    const t = i / numParticles;
                    const segment = Math.floor(t * 10);
                    const localT = (t * 10) % 1;
                    const angle = t * Math.PI * 6 + segment * 0.5;
                    const bodyWidth = 0.3 + Math.sin(t * Math.PI * 3) * 0.2;
                    
                    vx = Math.cos(angle) * speed * bodyWidth + (Math.random() - 0.5) * 0.1;
                    vy = t * speed * 1.5 + Math.sin(angle * 2) * speed * 0.3;
                    vz = Math.sin(angle) * speed * bodyWidth + (Math.random() - 0.5) * 0.1;
                    
                    // Add wing-like particles
                    if (segment === 3 || segment === 7) {
                        const wingDir = (segment === 3) ? 1 : -1;
                        vx += wingDir * speed * localT * 0.5;
                    }
                } else {
                    // Spherical
                    const theta = Math.random() * Math.PI * 2;
                    const phi = Math.acos(2 * Math.random() - 1);
                    let r = speed;
                    
                    if (config.upwardBias) {
                        r *= (1 + config.upwardBias * (1 + Math.cos(phi)) / 2);
                    }
                    
                    vx = r * Math.sin(phi) * Math.cos(theta) * config.spread;
                    vy = r * Math.cos(phi) * (config.upwardBias ? Math.abs(Math.cos(phi)) : 1);
                    vz = r * Math.sin(phi) * Math.sin(theta) * config.spread;
                }
                
                p.active = true;
                p.x = x;
                p.y = y;
                p.z = z;
                p.vx = vx;
                p.vy = vy;
                p.vz = vz;
                
                // Color variation
                const variation = config.magical ? 0.3 : 0.1;
                p.r = Math.min(1, rgb.r + (Math.random() - 0.5) * variation);
                p.g = Math.min(1, rgb.g + (Math.random() - 0.5) * variation);
                p.b = Math.min(1, rgb.b + (Math.random() - 0.5) * variation);
                
                if (config.magical) {
                    // Magical color shifting
                    const hueShift = Math.random() * 0.3;
                    p.r = Math.min(1, p.r + hueShift);
                    p.b = Math.min(1, p.b + hueShift * 0.5);
                }
                
                p.size = config.size * (0.5 + Math.random() * 0.5) * scale;
                p.alpha = 1;
                p.life = config.life * (0.7 + Math.random() * 0.3);
                p.maxLife = p.life;
                p.gravity = config.gravity;
                p.drag = config.drag;
                p.trail = config.trail || false;
                p.fadeStart = config.trail ? 0.5 : 0.3;
            }
            
            console.log('‚úÖ Created', createdCount, 'particles for explosion');
            
            // Handle secondary explosions
            if (config.secondary) {
                setTimeout(() => {
                    const secondaryCount = 6 + Math.floor(Math.random() * 4);
                    for (let i = 0; i < secondaryCount; i++) {
                        const angle = (i / secondaryCount) * Math.PI * 2;
                        const dist = 3 * scale;
                        createExplosion(
                            x + Math.cos(angle) * dist,
                            y + Math.sin(angle) * dist * 0.5,
                            z + Math.sin(angle) * dist,
                            'classic',
                            color,
                            scale * 0.4
                        );
                    }
                }, config.secondaryDelay * 1000);
            }
            
            // Handle multi-stage
            if (config.stages && config.stages > 1) {
                for (let stage = 1; stage < config.stages; stage++) {
                    setTimeout(() => {
                        const offsetX = (Math.random() - 0.5) * 4 * scale;
                        const offsetY = 2 + Math.random() * 3 * scale;
                        createExplosion(
                            x + offsetX,
                            y + offsetY,
                            z + (Math.random() - 0.5) * 2,
                            config.pattern === 'dragon' ? 'spiral' : 'classic',
                            color,
                            scale * (0.5 + Math.random() * 0.3)
                        );
                        if (config.magical && Math.random() > 0.5) {
                            audio.playCrackle();
                        }
                    }, config.stageDelay * 1000 * stage);
                }
            }
        }
        
        // ==================== ROCKET / LAUNCH ====================
        class Rocket {
            constructor(startX, startY, targetX, targetY, targetZ, type, color) {
                this.x = startX;
                this.y = startY;
                this.z = 0;
                this.targetX = targetX;
                this.targetY = targetY;
                this.targetZ = targetZ;
                this.type = type;
                this.color = color;
                this.active = true;
                this.speed = 0.4 + Math.random() * 0.2;
                this.trailTimer = 0;
                
                const dx = targetX - startX;
                const dy = targetY - startY;
                const dist = Math.sqrt(dx * dx + dy * dy);
                this.vx = (dx / dist) * this.speed;
                this.vy = (dy / dist) * this.speed;
                this.vz = (targetZ / dist) * this.speed;
            }
            
            update(dt) {
                if (!this.active) return;
                
                this.x += this.vx;
                this.y += this.vy;
                this.z += this.vz;
                
                // Trail particles
                this.trailTimer += dt;
                if (this.trailTimer > 0.02) {
                    this.trailTimer = 0;
                    const p = getParticle();
                    if (p) {
                        p.active = true;
                        p.x = this.x + (Math.random() - 0.5) * 0.2;
                        p.y = this.y + (Math.random() - 0.5) * 0.2;
                        p.z = this.z + (Math.random() - 0.5) * 0.2;
                        p.vx = (Math.random() - 0.5) * 0.02;
                        p.vy = -0.05 - Math.random() * 0.03;
                        p.vz = (Math.random() - 0.5) * 0.02;
                        p.r = 1;
                        p.g = 0.8;
                        p.b = 0.3;
                        p.size = 2;
                        p.alpha = 1;
                        p.life = 0.3;
                        p.maxLife = 0.3;
                        p.gravity = 0.01;
                        p.drag = 0.95;
                    }
                }
                
                // Check if reached target
                const dy = this.targetY - this.y;
                if (dy <= 0 || this.y >= this.targetY) {
                    console.log('üí• Rocket reached target at:', this.x, this.y, this.z);
                    this.active = false;
                    createExplosion(this.targetX, this.targetY, this.targetZ, this.type, this.color);
                }
            }
        }
        
        const rockets = [];
        
        function launchFirework(screenX, screenY, type, color) {
            console.log('üöÄ launchFirework called:', { screenX, screenY, type, color });
            audio.playLaunch();
            
            // Convert screen coordinates to world coordinates
            const rect = renderer.domElement.getBoundingClientRect();
            console.log('üìê Canvas rect:', rect);
            const x = ((screenX - rect.left) / rect.width) * 2 - 1;
            const y = -((screenY - rect.top) / rect.height) * 2 + 1;
            console.log('üìç Normalized coords:', { x, y });
            
            const vector = new THREE.Vector3(x, y, 0.5);
            vector.unproject(camera);
            const dir = vector.sub(camera.position).normalize();
            const distance = (15 - camera.position.y) / dir.y;
            const targetPos = camera.position.clone().add(dir.multiplyScalar(distance));
            
            // Clamp target position
            targetPos.x = Math.max(-25, Math.min(25, targetPos.x));
            targetPos.y = Math.max(8, Math.min(25, 10 + Math.random() * 10));
            targetPos.z = (Math.random() - 0.5) * 10;
            
            console.log('üéØ Target position:', targetPos);
            
            const startX = targetPos.x + (Math.random() - 0.5) * 2;
            const startY = 0;
            
            const rocket = new Rocket(startX, startY, targetPos.x, targetPos.y, targetPos.z, type, color);
            rockets.push(rocket);
            console.log('üöÄ Rocket created:', rocket, 'Total rockets:', rockets.length);
        }
        
        function launchAtPosition(worldX, worldY, worldZ, type, color) {
            audio.playLaunch();
            const startX = worldX + (Math.random() - 0.5) * 2;
            rockets.push(new Rocket(startX, 0, worldX, worldY, worldZ, type, color));
        }

        // ==================== TIMELINE SYSTEM ====================
        let timelineEvents = [];
        let isPlaying = false;
        let isPaused = false;
        let currentTime = 0;
        let duration = 30;
        let pixelsPerSecond = 50;
        let isLooping = false;
        let selectedType = 'classic';
        let selectedColor = '#ff3333';
        let selectedEvent = null;
        let draggedEvent = null;
        let dragOffset = 0;
        
        function updateTimeline() {
            const ruler = document.getElementById('timeline-ruler');
            const timeline = document.getElementById('timeline');
            const totalWidth = duration * pixelsPerSecond + 80;
            timeline.style.width = totalWidth + 'px';
            
            // Update ruler
            ruler.innerHTML = '';
            for (let t = 0; t <= duration; t++) {
                const mark = document.createElement('div');
                mark.className = 'ruler-mark' + (t % 5 === 0 ? ' major' : '');
                mark.style.left = (80 + t * pixelsPerSecond) + 'px';
                if (t % 5 === 0) {
                    mark.textContent = t + 's';
                }
                ruler.appendChild(mark);
            }
        }
        
        function renderEvents() {
            document.querySelectorAll('.timeline-event').forEach(el => el.remove());
            
            timelineEvents.forEach((event, index) => {
                const track = document.querySelector(`.track[data-track="${event.track}"] .track-content`);
                if (!track) return;
                
                const el = document.createElement('div');
                el.className = 'timeline-event' + (selectedEvent === index ? ' selected' : '');
                el.style.left = (event.time * pixelsPerSecond) + 'px';
                el.style.background = event.color;
                el.style.width = '80px';
                el.dataset.index = index;
                el.innerHTML = `
                    ${FIREWORK_TYPES[event.type]?.name || event.type}
                    <button class="delete-btn">√ó</button>
                `;
                
                el.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    timelineEvents.splice(index, 1);
                    renderEvents();
                });
                
                el.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('delete-btn')) return;
                    e.stopPropagation();
                    selectedEvent = index;
                    draggedEvent = index;
                    dragOffset = e.clientX - el.getBoundingClientRect().left;
                    renderEvents();
                });
                
                track.appendChild(el);
            });
        }
        
        function addTimelineEvent(time, track, type, color) {
            timelineEvents.push({ time, track, type, color });
            timelineEvents.sort((a, b) => a.time - b.time);
            renderEvents();
        }
        
        // Timeline interactions
        document.getElementById('drop-zone').addEventListener('click', (e) => {
            if (isPlaying) return;
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left + document.getElementById('timeline-scroll').scrollLeft;
            const time = Math.max(0, x / pixelsPerSecond);
            const trackEl = document.elementFromPoint(e.clientX, e.clientY)?.closest('.track');
            const track = trackEl ? parseInt(trackEl.dataset.track) : 0;
            addTimelineEvent(time, track, selectedType, selectedColor);
        });
        
        document.addEventListener('mousemove', (e) => {
            if (draggedEvent !== null) {
                const scroll = document.getElementById('timeline-scroll');
                const rect = scroll.getBoundingClientRect();
                const x = e.clientX - rect.left - 80 + scroll.scrollLeft - dragOffset + 40;
                const newTime = Math.max(0, Math.min(duration, x / pixelsPerSecond));
                timelineEvents[draggedEvent].time = newTime;
                renderEvents();
            }
        });
        
        document.addEventListener('mouseup', () => {
            draggedEvent = null;
        });
        
        // Playhead scrubbing
        document.getElementById('timeline-ruler').addEventListener('mousedown', (e) => {
            const rect = e.target.getBoundingClientRect();
            const scroll = document.getElementById('timeline-scroll');
            const x = e.clientX - rect.left + scroll.scrollLeft - 80;
            currentTime = Math.max(0, Math.min(duration, x / pixelsPerSecond));
            updatePlayhead();
            
            const onMove = (e) => {
                const x = e.clientX - rect.left + scroll.scrollLeft - 80;
                currentTime = Math.max(0, Math.min(duration, x / pixelsPerSecond));
                updatePlayhead();
            };
            
            const onUp = () => {
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
            };
            
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);
        });
        
        function updatePlayhead() {
            const playhead = document.getElementById('playhead');
            playhead.style.left = (80 + currentTime * pixelsPerSecond) + 'px';
            
            const minutes = Math.floor(currentTime / 60);
            const seconds = Math.floor(currentTime % 60);
            const tenths = Math.floor((currentTime % 1) * 10);
            document.getElementById('time-display').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}.${tenths}`;
        }
        
        // Playback
        let lastEventIndex = 0;
        
        function playTimeline() {
            if (timelineEvents.length === 0) {
                // Still allow play mode, but hint that timeline is empty
                console.log('Timeline is empty - click canvas to launch manually or load a preset');
            }
            isPlaying = true;
            isPaused = false;
            lastEventIndex = 0;
            
            // Find first event after current time
            for (let i = 0; i < timelineEvents.length; i++) {
                if (timelineEvents[i].time >= currentTime) {
                    lastEventIndex = i;
                    break;
                }
            }
            
            document.getElementById('play-btn').textContent = '‚è∏ Pause';
            document.getElementById('tl-play-btn').textContent = '‚è∏';
            document.getElementById('click-to-launch-hint').classList.add('hidden');
        }
        
        function pauseTimeline() {
            isPaused = true;
            document.getElementById('play-btn').textContent = '‚ñ∂ Play';
            document.getElementById('tl-play-btn').textContent = '‚ñ∂';
        }
        
        function stopTimeline() {
            isPlaying = false;
            isPaused = false;
            currentTime = 0;
            lastEventIndex = 0;
            updatePlayhead();
            document.getElementById('play-btn').textContent = '‚ñ∂ Play';
            document.getElementById('tl-play-btn').textContent = '‚ñ∂';
            document.getElementById('click-to-launch-hint').classList.remove('hidden');
        }
        
        function updatePlayback(dt) {
            if (!isPlaying || isPaused) return;
            
            currentTime += dt;
            
            // Trigger events
            while (lastEventIndex < timelineEvents.length && 
                   timelineEvents[lastEventIndex].time <= currentTime) {
                const event = timelineEvents[lastEventIndex];
                const x = (event.track - 1.5) * 8 + (Math.random() - 0.5) * 4;
                const y = 10 + Math.random() * 8;
                const z = (Math.random() - 0.5) * 5;
                launchAtPosition(x, y, z, event.type, event.color);
                lastEventIndex++;
            }
            
            // Loop or stop
            if (currentTime >= duration) {
                if (isLooping) {
                    currentTime = 0;
                    lastEventIndex = 0;
                } else {
                    stopTimeline();
                }
            }
            
            updatePlayhead();
        }
        
        // UI Controls
        document.getElementById('play-btn').addEventListener('click', () => {
            audio.resume(); // Unlock audio
            if (isPlaying && !isPaused) {
                pauseTimeline();
            } else {
                playTimeline();
            }
        });
        
        document.getElementById('tl-play-btn').addEventListener('click', () => {
            if (isPlaying && !isPaused) {
                pauseTimeline();
            } else {
                playTimeline();
            }
        });
        
        document.getElementById('stop-btn').addEventListener('click', stopTimeline);
        
        document.getElementById('loop-btn').addEventListener('click', function() {
            isLooping = !isLooping;
            this.classList.toggle('active', isLooping);
        });
        
        document.getElementById('zoom-in').addEventListener('click', () => {
            pixelsPerSecond = Math.min(200, pixelsPerSecond + 10);
            updateTimeline();
            renderEvents();
        });
        
        document.getElementById('zoom-out').addEventListener('click', () => {
            pixelsPerSecond = Math.max(20, pixelsPerSecond - 10);
            updateTimeline();
            renderEvents();
        });
        
        document.getElementById('duration-input').addEventListener('change', function() {
            duration = Math.max(5, Math.min(300, parseInt(this.value) || 30));
            this.value = duration;
            updateTimeline();
        });
        
        // Firework type selection
        document.querySelectorAll('.firework-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.firework-btn').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                selectedType = this.dataset.type;
            });
        });
        
        // Color selection
        document.querySelectorAll('.color-swatch').forEach(swatch => {
            swatch.addEventListener('click', function() {
                document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
                this.classList.add('selected');
                selectedColor = this.dataset.color;
            });
        });
        
        // Click to launch (works anytime, including during playback)
        renderer.domElement.addEventListener('click', (e) => {
            console.log('üñ±Ô∏è Canvas clicked at:', e.clientX, e.clientY);
            audio.resume(); // Ensure audio context is unlocked
            launchFirework(e.clientX, e.clientY, selectedType, selectedColor);
        });
        
        // Unlock audio on any interaction
        document.addEventListener('click', () => audio.resume(), { once: true });
        
        // Save/Load
        document.getElementById('save-btn').addEventListener('click', () => {
            const data = {
                version: 1,
                duration,
                events: timelineEvents
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'fireworks-show.json';
            a.click();
            URL.revokeObjectURL(url);
        });
        
        document.getElementById('load-btn').addEventListener('click', () => {
            document.getElementById('file-input').click();
        });
        
        document.getElementById('file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.events) {
                        timelineEvents = data.events;
                        duration = data.duration || 30;
                        document.getElementById('duration-input').value = duration;
                        updateTimeline();
                        renderEvents();
                    }
                } catch (err) {
                    alert('Invalid file format');
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        });
        
        document.getElementById('clear-btn').addEventListener('click', () => {
            if (confirm('Clear all events?')) {
                timelineEvents = [];
                renderEvents();
            }
        });
        
        // Presets
        const PRESETS = {
            opener: {
                duration: 15,
                events: [
                    { time: 0.5, track: 1, type: 'classic', color: '#ff3333' },
                    { time: 0.7, track: 2, type: 'classic', color: '#33ff33' },
                    { time: 0.9, track: 3, type: 'classic', color: '#3333ff' },
                    { time: 2, track: 1, type: 'peony', color: '#ffcc00' },
                    { time: 2.5, track: 2, type: 'peony', color: '#ff6699' },
                    { time: 4, track: 0, type: 'chrysanthemum', color: '#ffffff' },
                    { time: 4, track: 3, type: 'chrysanthemum', color: '#ffffff' },
                    { time: 6, track: 1, type: 'willow', color: '#ffcc00' },
                    { time: 6, track: 2, type: 'willow', color: '#ffcc00' },
                ]
            },
            crescendo: {
                duration: 20,
                events: [
                    { time: 0, track: 1, type: 'classic', color: '#3333ff' },
                    { time: 2, track: 2, type: 'classic', color: '#3333ff' },
                    { time: 2, track: 1, type: 'classic', color: '#33ffff' },
                    { time: 4, track: 0, type: 'peony', color: '#ff33ff' },
                    { time: 4, track: 3, type: 'peony', color: '#ff33ff' },
                    { time: 4, track: 1, type: 'classic', color: '#ffff33' },
                    { time: 6, track: 0, type: 'crossette', color: '#ff3333' },
                    { time: 6, track: 1, type: 'crossette', color: '#ff3333' },
                    { time: 6, track: 2, type: 'crossette', color: '#ff3333' },
                    { time: 6, track: 3, type: 'crossette', color: '#ff3333' },
                    { time: 8, track: 1, type: 'multibreak', color: '#ffffff' },
                    { time: 8.5, track: 2, type: 'multibreak', color: '#ffcc00' },
                    { time: 10, track: 0, type: 'spiral', color: '#33ff33' },
                    { time: 10, track: 3, type: 'spiral', color: '#33ff33' },
                ]
            },
            finale: {
                duration: 25,
                events: (() => {
                    const events = [];
                    const colors = ['#ff3333', '#ff8833', '#ffff33', '#33ff33', '#33ffff', '#3333ff', '#ff33ff', '#ffffff'];
                    const types = ['classic', 'peony', 'chrysanthemum', 'crossette', 'multibreak'];
                    
                    // Build-up
                    for (let i = 0; i < 20; i++) {
                        events.push({
                            time: i * 0.3,
                            track: i % 4,
                            type: types[i % types.length],
                            color: colors[i % colors.length]
                        });
                    }
                    
                    // Finale burst
                    for (let i = 0; i < 30; i++) {
                        events.push({
                            time: 8 + i * 0.15,
                            track: i % 4,
                            type: types[Math.floor(Math.random() * types.length)],
                            color: colors[Math.floor(Math.random() * colors.length)]
                        });
                    }
                    
                    // Grand finale
                    for (let i = 0; i < 16; i++) {
                        events.push({
                            time: 14 + i * 0.1,
                            track: i % 4,
                            type: 'multibreak',
                            color: '#ffffff'
                        });
                    }
                    
                    return events;
                })()
            },
            'gandalf-show': {
                duration: 30,
                events: [
                    { time: 0, track: 1, type: 'spiral', color: '#33ffff' },
                    { time: 0.5, track: 2, type: 'spiral', color: '#ff33ff' },
                    { time: 2, track: 1, type: 'gandalf', color: '#ff3333' },
                    { time: 5, track: 2, type: 'gandalf', color: '#ffcc00' },
                    { time: 8, track: 0, type: 'gandalf', color: '#33ff33' },
                    { time: 8, track: 3, type: 'gandalf', color: '#33ff33' },
                    { time: 11, track: 1, type: 'multibreak', color: '#ffffff' },
                    { time: 11.3, track: 2, type: 'multibreak', color: '#ffffff' },
                    { time: 13, track: 0, type: 'gandalf', color: '#3333ff' },
                    { time: 13, track: 1, type: 'gandalf', color: '#ff33ff' },
                    { time: 13, track: 2, type: 'gandalf', color: '#33ffff' },
                    { time: 13, track: 3, type: 'gandalf', color: '#ffff33' },
                    { time: 17, track: 1, type: 'gandalf', color: '#ffffff' },
                    { time: 17, track: 2, type: 'gandalf', color: '#ffffff' },
                ]
            }
        };
        
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const preset = PRESETS[this.dataset.preset];
                if (preset) {
                    timelineEvents = JSON.parse(JSON.stringify(preset.events));
                    duration = preset.duration;
                    document.getElementById('duration-input').value = duration;
                    updateTimeline();
                    renderEvents();
                }
            });
        });

        // ==================== ANIMATION LOOP ====================
        const clock = new THREE.Clock();
        let frameCount = 0;
        let lastDebugTime = 0;
        
        function animate() {
            requestAnimationFrame(animate);
            
            const dt = Math.min(clock.getDelta(), 0.1);
            frameCount++;
            
            // Debug every second
            const now = performance.now();
            if (now - lastDebugTime > 200) { // Update 5x per second for visibility
                lastDebugTime = now;
                let activeParticles = 0;
                for (const p of particles) {
                    if (p.active) activeParticles++;
                }
                
                // Update visible debug overlay
                document.getElementById('debug-overlay').innerHTML = 
                    `Rockets: ${rockets.length}<br>` +
                    `Particles: ${activeParticles}<br>` +
                    `FPS: ${Math.round(1/dt)}<br>` +
                    `Canvas: ${container.clientWidth}x${container.clientHeight}`;
                
                if (rockets.length > 0 || activeParticles > 0) {
                    console.log(`üìä Frame ${frameCount}: ${rockets.length} rockets, ${activeParticles} active particles, dt=${dt.toFixed(4)}`);
                }
            }
            
            // Update rockets
            for (let i = rockets.length - 1; i >= 0; i--) {
                rockets[i].update(dt);
                if (!rockets[i].active) {
                    rockets.splice(i, 1);
                }
            }
            
            // Update particles
            let activeCount = 0;
            for (const p of particles) {
                p.update(dt);
                if (p.active) activeCount++;
            }
            
            // Update buffers
            const posAttr = particleGeometry.getAttribute('position');
            const colAttr = particleGeometry.getAttribute('color');
            const sizeAttr = particleGeometry.getAttribute('size');
            const alphaAttr = particleGeometry.getAttribute('alpha');
            
            let idx = 0;
            for (const p of particles) {
                if (p.active && idx < MAX_PARTICLES) {
                    posAttr.array[idx * 3] = p.x;
                    posAttr.array[idx * 3 + 1] = p.y;
                    posAttr.array[idx * 3 + 2] = p.z;
                    colAttr.array[idx * 3] = p.r;
                    colAttr.array[idx * 3 + 1] = p.g;
                    colAttr.array[idx * 3 + 2] = p.b;
                    sizeAttr.array[idx] = p.size;
                    alphaAttr.array[idx] = p.alpha;
                    idx++;
                }
            }
            
            // setDrawRange handles visibility, no need to clear remaining indices
            
            posAttr.needsUpdate = true;
            colAttr.needsUpdate = true;
            sizeAttr.needsUpdate = true;
            alphaAttr.needsUpdate = true;
            
            // CRITICAL: Only draw the active particles, not all 100k
            particleGeometry.setDrawRange(0, idx);
            
            // Log buffer state occasionally
            if (idx > 0 && frameCount % 30 === 0) {
                console.log(`üîß Draw range: 0-${idx}, First particle pos: (${posAttr.array[0].toFixed(2)}, ${posAttr.array[1].toFixed(2)}, ${posAttr.array[2].toFixed(2)}), alpha: ${alphaAttr.array[0].toFixed(2)}, size: ${sizeAttr.array[0].toFixed(2)}`);
            }
            
            // Update playback
            updatePlayback(dt);
            
            renderer.render(scene, camera);
            
            // Log render stats occasionally
            if (frameCount === 10) {
                console.log('üé¨ Render stats after 10 frames:', renderer.info.render);
                console.log('üé¨ Memory stats:', renderer.info.memory);
            }
        }
        
        // ==================== INIT ====================
        window.addEventListener('resize', () => {
            const w = container.clientWidth;
            const h = container.clientHeight;
            camera.aspect = w / h;
            camera.updateProjectionMatrix();
            renderer.setSize(w, h);
        });
        
        updateTimeline();
        animate();
        
        // Startup diagnostics
        console.log('üéÜ Fireworks Display Builder loaded');
        console.log('Max particles:', MAX_PARTICLES);
        console.log('üìê Container size:', container.clientWidth, 'x', container.clientHeight);
        console.log('üìê Renderer size:', renderer.domElement.width, 'x', renderer.domElement.height);
        console.log('üì∑ Camera position:', camera.position);
        console.log('üé® Renderer info:', renderer.info);
        console.log('‚úÖ Particle system in scene:', scene.children.includes(particleSystem));
        console.log('‚úÖ Sky in scene:', scene.children.includes(sky));
    </script>
</body>
</html>
